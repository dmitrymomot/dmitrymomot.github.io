---
import Layout from '../../../../layouts/Layout.astro';
import Footer from '../../../../components/Footer.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const posts = await getCollection('blog', ({ data }) => {
    return !data.draft;
  });

  const allTags = new Set<string>();
  posts.forEach(post => {
    post.data.tags.forEach(tag => allTags.add(tag));
  });

  const paths = [];
  for (const tag of allTags) {
    const tagPosts = posts.filter(post =>
      post.data.tags.includes(tag)
    );
    tagPosts.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

    const tagPages = paginate(tagPosts, {
      pageSize: 5,
      params: { tag }
    });

    paths.push(...tagPages);
  }

  return paths;
};

const { page } = Astro.props;
const { tag } = Astro.params;
---

<Layout title={`#${tag} - Dmytro Momot`} description={`Articles about ${tag}`}>
  <div class="h-px bg-[#2A2B30]"></div>

  <!-- Hero with breadcrumb -->
  <section class="bg-[#16171B]">
    <div class="max-w-[1280px] mx-auto flex flex-col gap-4 pt-[60px] pb-5 px-6 lg:px-[120px]">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2">
        <a href="/blog" class="font-mono text-[11px] font-medium text-[#52525B] hover:text-[#71717A] transition-colors">Blog</a>
        <span class="font-mono text-[11px] text-[#3F3F46]">/</span>
        <a href="/blog/tags" class="font-mono text-[11px] font-medium text-[#52525B] hover:text-[#71717A] transition-colors">Topics</a>
        <span class="font-mono text-[11px] text-[#3F3F46]">/</span>
        <span class="font-mono text-[11px] font-medium text-[#22C55E]">{tag}</span>
      </nav>

      <h1 class="text-3xl md:text-[40px] font-bold text-[#F4F4F5]" style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -1px;">
        #{tag}
      </h1>
      <p class="font-mono text-xs font-medium text-[#52525B]">
        {page.total} {page.total === 1 ? 'post' : 'posts'}
      </p>
    </div>
  </section>

  <!-- Posts List -->
  <section class="bg-[#16171B]">
    <div class="max-w-[1280px] mx-auto px-6 lg:px-[120px] pb-10">
      {page.data.map((post) => (
        <article class="flex flex-col md:flex-row gap-4 md:gap-10 py-7 border-t border-[#2A2B30]">
          <div class="flex-shrink-0">
            <time class="font-mono text-xs font-medium text-[#52525B] whitespace-nowrap">
              {post.data.publishDate.toLocaleDateString('en-US', {
                month: 'short',
                day: '2-digit',
                year: 'numeric'
              })}
            </time>
          </div>
          <div class="flex flex-col gap-3">
            <h2 style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.3px;">
              <a href={`/blog/${post.id}`} class="text-[22px] font-bold text-[#F4F4F5] hover:text-[#22C55E] transition-colors">
                {post.data.title}
              </a>
            </h2>
            <p class="text-sm text-[#71717A] leading-relaxed">
              {post.data.description}
            </p>
            <div class="flex gap-2 flex-wrap">
              {post.data.tags.map((postTag) => (
                <a
                  href={`/blog/tag/${postTag}`}
                  class:list={[
                    "border rounded-sm px-2 py-0.5 font-mono text-[10px] font-medium transition-colors",
                    postTag === tag
                      ? "border-[#22C55E] text-[#22C55E]"
                      : "border-[#3F3F46] text-[#52525B] hover:text-[#71717A] hover:border-[#52525B]"
                  ]}
                >
                  {postTag}
                </a>
              ))}
            </div>
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- Pagination -->
  {page.lastPage > 1 && (
    <section class="bg-[#16171B]">
      <div class="max-w-[1280px] mx-auto flex justify-center items-center gap-2 py-10 px-6 lg:px-[120px]">
        {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((num) => (
          <a
            href={num === 1 ? `/blog/tag/${tag}` : `/blog/tag/${tag}/${num}`}
            class:list={[
              "font-mono text-[13px] font-medium rounded-sm px-3.5 py-2 transition-colors",
              num === page.currentPage
                ? "bg-[#22C55E] text-[#16171B] font-bold"
                : "border border-[#2A2B30] text-[#71717A] hover:text-[#F4F4F5] hover:border-[#3F3F46]"
            ]}
          >
            {num}
          </a>
        ))}
        {page.url.next && (
          <a
            href={page.url.next}
            class="font-mono text-[13px] font-medium rounded-sm px-3.5 py-2 border border-[#2A2B30] text-[#71717A] hover:text-[#F4F4F5] hover:border-[#3F3F46] transition-colors"
          >
            &rarr;
          </a>
        )}
      </div>
    </section>
  )}

  <div class="h-px bg-[#2A2B30]"></div>
  <Footer />
</Layout>
