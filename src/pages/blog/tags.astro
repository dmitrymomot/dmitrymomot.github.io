---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog', ({ data }) => {
  return !data.draft;
});

// Count posts per tag
const tagCounts = new Map<string, number>();
posts.forEach(post => {
  post.data.tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Sort tags by count (descending) then alphabetically
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1];
    return a[0].localeCompare(b[0]);
  });

// Popular tags: top 8
const popularTags = sortedTags.slice(0, 8);

// All tags sorted alphabetically
const allTagsSorted = Array.from(tagCounts.entries())
  .sort((a, b) => a[0].localeCompare(b[0]));
---

<Layout title="All Topics - Dmytro Momot" description="Browse all topics from the blog">
  <div class="h-px bg-[#2A2B30]"></div>

  <!-- Hero -->
  <section class="bg-[#16171B]">
    <div class="max-w-[1280px] mx-auto flex flex-col gap-3 pt-[60px] pb-5 px-6 lg:px-[120px]">
      <p class="font-mono text-[11px] font-semibold text-[#71717A]">// TOPICS</p>
      <h1 class="text-3xl md:text-[40px] font-bold text-[#F4F4F5]" style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -1px;">
        Browse by topic
      </h1>
      <p class="font-mono text-xs font-medium text-[#52525B]">
        {tagCounts.size} topics across {posts.length} articles
      </p>
    </div>
  </section>

  <!-- Popular -->
  <section class="bg-[#16171B]">
    <div class="max-w-[1280px] mx-auto flex flex-col gap-6 pt-10 px-6 lg:px-[120px]">
      <p class="font-mono text-xs font-bold text-[#22C55E] uppercase tracking-wider">Popular</p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        {popularTags.map(([tag, count]) => (
          <a
            href={`/blog/tag/${tag}`}
            class="flex items-center justify-between border border-[#2A2B30] rounded py-3.5 px-5 hover:border-[#3F3F46] transition-colors"
          >
            <span class="font-mono text-sm font-semibold text-[#F4F4F5]">{tag}</span>
            <span class="font-mono text-xs font-medium text-[#52525B]">{count}</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- All Topics -->
  <section class="bg-[#16171B]">
    <div class="max-w-[1280px] mx-auto flex flex-col gap-6 pt-10 pb-[60px] px-6 lg:px-[120px]">
      <p class="font-mono text-xs font-bold text-[#71717A] uppercase tracking-wider">All Topics</p>
      <div class="flex flex-wrap gap-2">
        {allTagsSorted.map(([tag]) => (
          <a
            href={`/blog/tag/${tag}`}
            class="border border-[#3F3F46] rounded-sm py-1.5 px-3 font-mono text-[11px] font-medium text-[#71717A] hover:text-[#F4F4F5] hover:border-[#52525B] transition-colors"
          >
            {tag}
          </a>
        ))}
      </div>
    </div>
  </section>

  <div class="h-px bg-[#2A2B30]"></div>
  <Footer />
</Layout>
